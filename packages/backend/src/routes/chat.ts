import express from 'express';

const router = express.Router();

const OPENROUTER_API_KEY = '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';
const MODEL = 'openrouter/auto';
const USE_FALLBACK = true; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ fallback –∑–∞–º—ñ—Å—Ç—å API (–ø–æ–∫–∏ –Ω–µ–º–∞—î –∫—Ä–µ–¥–∏—Ç—ñ–≤)

// System prompt –¥–ª—è AI –∞—Å—ñ—Å—Ç–µ–Ω—Ç–∞
const SYSTEM_PROMPT = `–¢–∏ - SunBot, –¥—Ä—É–∂–Ω—ñ–π AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç –º–∞–≥–∞–∑–∏–Ω—É Sunleaf, —è–∫–∏–π –ø—Ä–æ–¥–∞—î –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ñ —Ç–∞ –µ–∫–æ–ª–æ–≥—ñ—á–Ω—ñ —Ç–æ–≤–∞—Ä–∏.

–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –º–∞–≥–∞–∑–∏–Ω:
- –ù–∞–∑–≤–∞: Sunleaf (–°–∞–Ω–ª—ñ—Ñ)
- –°–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è: –ù–∞—Ç—É—Ä–∞–ª—å–Ω—ñ –µ–∫–æ–ª–æ–≥—ñ—á–Ω—ñ —Ç–æ–≤–∞—Ä–∏ (—á–∞—ó, –∫–∞–≤–∞, –∫–æ—Å–º–µ—Ç–∏–∫–∞, –¥–µ–∫–æ—Ä)
- –î–æ—Å—Ç–∞–≤–∫–∞: 2-5 —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ–≤ –ø–æ –£–∫—Ä–∞—ó–Ω—ñ
- –í–∞—Ä—Ç—ñ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏: –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∞ –≤—ñ–¥ 1000‚Ç¥, —ñ–Ω–∞–∫—à–µ 80‚Ç¥
- –°–ø–æ—Å–æ–±–∏ –æ–ø–ª–∞—Ç–∏: –ö–∞—Ä—Ç–∫–æ—é –æ–Ω–ª–∞–π–Ω, –≥–æ—Ç—ñ–≤–∫–æ—é/–∫–∞—Ä—Ç–∫–æ—é –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ
- –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è: 14 –¥–Ω—ñ–≤ –∑ –º–æ–º–µ–Ω—Ç—É –æ—Ç—Ä–∏–º–∞–Ω–Ω—è

–ü–æ–ø—É–ª—è—Ä–Ω—ñ —Ç–æ–≤–∞—Ä–∏:
1. –ó–µ–ª–µ–Ω–∏–π —á–∞–π –º–∞—Ç—á–∞ (250‚Ç¥)
2. –û—Ä–≥–∞–Ω—ñ—á–Ω–∞ –∫–∞–≤–∞ –ê—Ä–∞–±—ñ–∫–∞ (350‚Ç¥)
3. –ù–∞—Ç—É—Ä–∞–ª—å–Ω–µ –º–∏–ª–æ —Ä—É—á–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ (120‚Ç¥)
4. –ê—Ä–æ–º–∞—Ç–∏—á–Ω–∞ —Å–≤—ñ—á–∫–∞ –∑ —Å–æ—î–≤–æ–≥–æ –≤–æ—Å–∫—É (180‚Ç¥)
5. –ï–∫–æ-—Å—É–º–∫–∞ –±–∞–≤–æ–≤–Ω—è–Ω–∞ (150‚Ç¥)
6. –ë–∞–º–±—É–∫–æ–≤–∞ –∑—É–±–Ω–∞ —â—ñ—Ç–∫–∞ (85‚Ç¥)

–¢–≤–æ—ó –∑–∞–≤–¥–∞–Ω–Ω—è:
- –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –∫–æ—Ä–æ—Ç–∫–æ —Ç–∞ –¥—Ä—É–∂–Ω—å–æ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é
- –î–æ–ø–æ–º–∞–≥–∞–π –∑ –≤–∏–±–æ—Ä–æ–º —Ç–æ–≤–∞—Ä—ñ–≤
- –ü–æ—è—Å–Ω—é–π —É–º–æ–≤–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ —Ç–∞ –æ–ø–ª–∞—Ç–∏
- –Ø–∫—â–æ –Ω–µ –∑–Ω–∞—î—à –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ, –ø–æ—Ä–∞–¥—å –∑–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –µ–º–æ–¥–∑—ñ –¥–ª—è –¥—Ä—É–∂–µ–ª—é–±–Ω–æ—Å—Ç—ñ üòä

–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –ø—Ä–∏—Ä–æ–¥–Ω–æ —Ç–∞ –∫–æ—Ä–∏—Å–Ω–æ!`;

// Fallback –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ñ –ø–∏—Ç–∞–Ω–Ω—è
const FALLBACK_RESPONSES: Record<string, string> = {
  '—è–∫ –æ—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è': '–©–æ–± –æ—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:\n1Ô∏è‚É£ –î–æ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä–∏ –¥–æ –∫–æ—à–∏–∫–∞, –Ω–∞—Ç–∏—Å–Ω—É–≤—à–∏ "–î–æ–¥–∞—Ç–∏ –¥–æ –∫–æ—à–∏–∫–∞"\n2Ô∏è‚É£ –ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ –∫–æ—à–∏–∫–∞ (—ñ–∫–æ–Ω–∫–∞ üõí –≤–≥–æ—Ä—ñ)\n3Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤\n4Ô∏è‚É£ –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"\n5Ô∏è‚É£ –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –¥–∞–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏ —Ç–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∏\n\n–Ø–∫—â–æ –≤–∏–Ω–∏–∫–Ω—É—Ç—å –ø–∏—Ç–∞–Ω–Ω—è - —è –∑–∞–≤–∂–¥–∏ —Ç—É—Ç! üòä',
  
  '—Å–∫—ñ–ª—å–∫–∏ —á–∞—Å—É –∑–∞–π–º–∞—î –¥–æ—Å—Ç–∞–≤–∫–∞': '–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –£–∫—Ä–∞—ó–Ω—ñ –∑–∞–π–º–∞—î:\nüì¶ 2-5 —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ–≤\nüöö –£ –≤–µ–ª–∏–∫—ñ –º—ñ—Å—Ç–∞ - —á–∞—Å—Ç–æ —à–≤–∏–¥—à–µ\nüìç –£ –≤—ñ–¥–¥–∞–ª–µ–Ω—ñ —Ä–µ–≥—ñ–æ–Ω–∏ - –¥–æ 5 –¥–Ω—ñ–≤\n\n–í–∞—Ä—Ç—ñ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏:\n‚úÖ –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∞ –≤—ñ–¥ 1000‚Ç¥\nüí∞ 80‚Ç¥ –ø—Ä–∏ —Å—É–º—ñ –º–µ–Ω—à–µ 1000‚Ç¥\n\n–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä –Ω–∞–¥—ñ—à–ª–µ–º–æ –Ω–∞ email –ø—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏! üìß',
  
  '—è–∫—ñ —Å–ø–æ—Å–æ–±–∏ –æ–ø–ª–∞—Ç–∏': '–ú–∏ –ø—Ä–∏–π–º–∞—î–º–æ —Ç–∞–∫—ñ —Å–ø–æ—Å–æ–±–∏ –æ–ø–ª–∞—Ç–∏:\n\nüí≥ –ö–∞—Ä—Ç–æ—é –æ–Ω–ª–∞–π–Ω:\n  ‚Ä¢ Visa, Mastercard\n  ‚Ä¢ –ë–µ–∑–ø–µ—á–Ω–∞ –æ–ø–ª–∞—Ç–∞\n  ‚Ä¢ –ú–∏—Ç—Ç—î–≤–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è\n\nüíµ –ü—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ:\n  ‚Ä¢ –ì–æ—Ç—ñ–≤–∫–æ—é –∫—É—Ä\'—î—Ä—É\n  ‚Ä¢ –ö–∞—Ä—Ç–∫–æ—é —á–µ—Ä–µ–∑ —Ç–µ—Ä–º—ñ–Ω–∞–ª\n  ‚Ä¢ –í –ø—É–Ω–∫—Ç—ñ –≤–∏–¥–∞—á—ñ\n\n–û–±–∏—Ä–∞–π—Ç–µ –∑—Ä—É—á–Ω–∏–π —Å–ø–æ—Å—ñ–±! üòä',
  
  '—è–∫ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ —Ç–æ–≤–∞—Ä': '–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É:\n\n‚úÖ –¢–µ—Ä–º—ñ–Ω: 14 –¥–Ω—ñ–≤ –∑ –º–æ–º–µ–Ω—Ç—É –æ—Ç—Ä–∏–º–∞–Ω–Ω—è\nüì¶ –¢–æ–≤–∞—Ä –º–∞—î –±—É—Ç–∏ –≤ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ–π —É–ø–∞–∫–æ–≤—Ü—ñ\nüè∑Ô∏è –ó–±–µ—Ä–µ–∂—ñ—Ç—å –≤—Å—ñ —è—Ä–ª–∏–∫–∏ —Ç–∞ –µ—Ç–∏–∫–µ—Ç–∫–∏\n\n–Ø–∫ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏:\n1. –ù–∞–ø–∏—à—ñ—Ç—å –Ω–∞–º –Ω–∞ email\n2. –í–∫–∞–∂—ñ—Ç—å –Ω–æ–º–µ—Ä –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è\n3. –û–ø–∏—à—ñ—Ç—å –ø—Ä–∏—á–∏–Ω—É –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è\n4. –ú–∏ –Ω–∞–¥—ñ—à–ª–µ–º–æ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó\n\nüí∞ –ì—Ä–æ—à—ñ –ø–æ–≤–µ—Ä–Ω–µ–º–æ –ø—Ä–æ—Ç—è–≥–æ–º 5-7 –¥–Ω—ñ–≤',
  
  '–∑–≤—ñ–¥–∫–∏ –ø–æ—Å—Ç–∞—á–∞—é—Ç—å—Å—è —Ç–æ–≤–∞—Ä–∏': '–ù–∞—à—ñ —Ç–æ–≤–∞—Ä–∏ - 100% —è–∫—ñ—Å—Ç—å! üåø\n\nüçµ –ß–∞–π —Ç–∞ –∫–∞–≤–∞:\n  ‚Ä¢ –ó –æ—Ä–≥–∞–Ω—ñ—á–Ω–∏—Ö –ø–ª–∞–Ω—Ç–∞—Ü—ñ–π\n  ‚Ä¢ –°–µ—Ä—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω—ñ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∏\n  ‚Ä¢ –ü—Ä—è–º—ñ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∏ –∑ —Ñ–µ—Ä–º–µ—Ä–∞–º–∏\n\nüß¥ –ö–æ—Å–º–µ—Ç–∏–∫–∞:\n  ‚Ä¢ –ù–∞—Ç—É—Ä–∞–ª—å–Ω—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏\n  ‚Ä¢ –ë–µ–∑ —Ö—ñ–º—ñ—ó —Ç–∞ –ø–∞—Ä–∞–±–µ–Ω—ñ–≤\n  ‚Ä¢ –†—É—á–Ω–∞ —Ä–æ–±–æ—Ç–∞ –º–∞–π—Å—Ç—Ä—ñ–≤\n\n‚ôªÔ∏è –ï–∫–æ–ª–æ–≥—ñ—á–Ω—ñ —Ç–æ–≤–∞—Ä–∏:\n  ‚Ä¢ Sustainable –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ\n  ‚Ä¢ Biodegradable –º–∞—Ç–µ—Ä—ñ–∞–ª–∏\n\n–Ø–∫—ñ—Å—Ç—å –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∞ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞–º–∏! üìú',
  
  '—è–∫—ñ —Ç–æ–≤–∞—Ä–∏': '–£ –Ω–∞—Å –≤–µ–ª–∏–∫–∏–π –≤–∏–±—ñ—Ä –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤! üåø\n\n‚òï –ù–∞–ø–æ—ó:\n  ‚Ä¢ –ó–µ–ª–µ–Ω–∏–π —á–∞–π –º–∞—Ç—á–∞ (250‚Ç¥)\n  ‚Ä¢ –û—Ä–≥–∞–Ω—ñ—á–Ω–∞ –∫–∞–≤–∞ –ê—Ä–∞–±—ñ–∫–∞ (350‚Ç¥)\n  ‚Ä¢ –¢—Ä–∞–≤—è–Ω—ñ –∑–±–æ—Ä–∏\n\nüßº –ö–æ—Å–º–µ—Ç–∏–∫–∞:\n  ‚Ä¢ –ù–∞—Ç—É—Ä–∞–ª—å–Ω–µ –º–∏–ª–æ —Ä—É—á–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ (120‚Ç¥)\n  ‚Ä¢ –®–∞–º–ø—É–Ω—ñ —Ç–∞ –∫–æ–Ω–¥–∏—Ü—ñ–æ–Ω–µ—Ä–∏\n  ‚Ä¢ –ö—Ä–µ–º–∏ –¥–ª—è –æ–±–ª–∏—á—á—è\n\nüïØÔ∏è –î–µ–∫–æ—Ä:\n  ‚Ä¢ –ê—Ä–æ–º–∞—Ç–∏—á–Ω—ñ —Å–≤—ñ—á–∫–∏ –∑ —Å–æ—î–≤–æ–≥–æ –≤–æ—Å–∫—É (180‚Ç¥)\n  ‚Ä¢ –ê—Ä–æ–º–∞-–¥–∏—Ñ—É–∑–æ—Ä–∏\n\n‚ôªÔ∏è –ï–∫–æ-—Ç–æ–≤–∞—Ä–∏:\n  ‚Ä¢ –ë–∞–≤–æ–≤–Ω—è–Ω—ñ –µ–∫–æ-—Å—É–º–∫–∏ (150‚Ç¥)\n  ‚Ä¢ –ë–∞–º–±—É–∫–æ–≤—ñ –∑—É–±–Ω—ñ —â—ñ—Ç–∫–∏ (85‚Ç¥)\n\n–ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥! üõçÔ∏è',
  
  'default': '–î—è–∫—É—é –∑–∞ –ø–∏—Ç–∞–Ω–Ω—è! üòä\n\n–Ø –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∑:\n‚Ä¢ –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è–º –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è\n‚Ä¢ –£–º–æ–≤–∞–º–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ —Ç–∞ –æ–ø–ª–∞—Ç–∏\n‚Ä¢ –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º —Ç–æ–≤–∞—Ä—É\n‚Ä¢ –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ –ø—Ä–æ–¥—É–∫—Ü—ñ—é\n\n–Ø–∫—â–æ —É –≤–∞—Å —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è, –Ω–∞—à –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∑–≤\'—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º! üìû\n\n–©–æ —Å–∞–º–µ –≤–∞—Å —Ü—ñ–∫–∞–≤–∏—Ç—å? üåø'
};

function getFallbackResponse(message: string): string {
  const lowerMessage = message.toLowerCase().trim();
  
  // –®—É–∫–∞—î–º–æ –∫–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞ –≤ –ø–∏—Ç–∞–Ω–Ω—ñ
  for (const [key, response] of Object.entries(FALLBACK_RESPONSES)) {
    if (key !== 'default' && lowerMessage.includes(key)) {
      return response;
    }
  }
  
  // –Ø–∫—â–æ –Ω–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ - –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –¥–µ—Ñ–æ–ª—Ç–Ω—É
  return FALLBACK_RESPONSES.default;
}

router.post('/', async (req, res) => {
  try {
    const { messages } = req.body;

    if (!messages || !Array.isArray(messages)) {
      return res.status(400).json({ error: 'Invalid messages format' });
    }

    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ fallback —è–∫—â–æ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π
    if (USE_FALLBACK) {
      const lastUserMessage = messages.filter((m: any) => m.role === 'user').pop();
      const response = getFallbackResponse(lastUserMessage?.content || '');
      return res.json({ message: response });
    }

    // –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∞ –ª–æ–≥—ñ–∫–∞ –∑ API (–∫–æ–ª–∏ –±—É–¥—É—Ç—å –∫—Ä–µ–¥–∏—Ç–∏)

    // –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∞ –ª–æ–≥—ñ–∫–∞ –∑ API (–∫–æ–ª–∏ –±—É–¥—É—Ç—å –∫—Ä–µ–¥–∏—Ç–∏)
    // –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –¥–ª—è OpenRouter
    const openRouterMessages = [
      { role: 'system', content: SYSTEM_PROMPT },
      ...messages
    ];

    // –ó–∞–ø–∏—Ç –¥–æ OpenRouter API
    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
        'Content-Type': 'application/json',
        'HTTP-Referer': 'http://localhost:5174',
        'X-Title': 'Sunleaf Shop'
      },
      body: JSON.stringify({
        model: MODEL,
        messages: openRouterMessages,
        temperature: 0.7,
        max_tokens: 500
      })
    });

    if (!response.ok) {
      const errorData = await response.json();
      console.error('OpenRouter API error:', errorData);
      throw new Error('OpenRouter API request failed');
    }

    const data = await response.json() as any;
    const assistantMessage = data.choices[0]?.message?.content;

    if (!assistantMessage) {
      throw new Error('No response from AI');
    }

    res.json({ message: assistantMessage });
  } catch (error) {
    console.error('Chat API error:', error);
    
    // Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
    const { messages } = req.body;
    const lastUserMessage = messages?.filter((m: any) => m.role === 'user').pop();
    const fallbackResponse = getFallbackResponse(lastUserMessage?.content || '');
    
    res.json({ message: fallbackResponse });
  }
});

export default router;
